# Caddyfile for BlockVantage deployment
# Main domain - serves the frontend
{$DOMAIN:localhost} {
    # Enable automatic HTTPS (Let's Encrypt)
    # For production, replace localhost with your actual domain
    
    # Reverse proxy to frontend service
    reverse_proxy frontend:3000
    
    # Enable compression
    encode gzip
    
    # Security headers
    header {
        # HSTS
        Strict-Transport-Security max-age=31536000;
        # Prevent MIME sniffing
        X-Content-Type-Options nosniff
        # XSS Protection
        X-XSS-Protection "1; mode=block"
        # Clickjacking protection
        X-Frame-Options DENY
        # Remove server info
        -Server
    }
    
    # Handle API routes - proxy to backend
    handle /api/* {
        reverse_proxy backend:8080
    }
    
    # Handle WebSocket connections
    handle /ws {
        reverse_proxy backend:8080
    }
    
    # Optional: Handle health checks
    handle /health {
        reverse_proxy backend:8080
    }
}

# Optional: API subdomain (if you want api.yourdomain.com)
{$API_DOMAIN:api.localhost} {
    reverse_proxy backend:8080
    
    encode gzip
    
    header {
        Strict-Transport-Security max-age=31536000;
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        X-Frame-Options DENY
        -Server
        # CORS headers for API
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
    }
}

# Global options
{
    # Email for Let's Encrypt (replace with your email)
    email {$ACME_EMAIL:admin@localhost}
    
    # Use Let's Encrypt staging for testing (remove for production)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}
